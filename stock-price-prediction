import yfinance as yf
import numpy as np
import matplotlib.pyplot as plt
from sklearn.preprocessing import MinMaxScaler
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Dense, LSTM

def get_latest_price(symbol):
    """Fetch latest stock closing price"""
    stock = yf.Ticker(symbol)
    data = stock.history(period="1d")
    return data['Close'][0]

def fetch_historical_data(symbol, start='2010-01-01', end='2025-12-28'):
    """Fetch historical stock data"""
    stock = yf.download(symbol, start=start, end=end)
    return stock['Close']

def create_dataset(dataset, time_step=60):
    """Prepare sequences for LSTM"""
    X, y = [], []
    for i in range(time_step, len(dataset)):
        X.append(dataset[i-time_step:i, 0])
        y.append(dataset[i, 0])
    return np.array(X), np.array(y)

def build_and_train_model(X_train, y_train, X_test, y_test, epochs=20, batch_size=32):
    """Build LSTM model and train"""
    model = Sequential()
    model.add(LSTM(50, return_sequences=True, input_shape=(X_train.shape[1], 1)))
    model.add(LSTM(50))
    model.add(Dense(1))
    model.compile(optimizer='adam', loss='mean_squared_error')
    model.fit(X_train, y_train, validation_data=(X_test, y_test), epochs=epochs, batch_size=batch_size, verbose=1)
    return model

def main():
    symbol = input("Enter stock symbol (example: AAPL): ").upper()
    
    # Latest price
    latest_price = get_latest_price(symbol)
    print(f"\nLatest price of {symbol}: ₹{latest_price:.2f}\n")
    
    # Historical data
    data = fetch_historical_data(symbol)
    
    # Scale data
    scaler = MinMaxScaler(feature_range=(0,1))
    scaled_data = scaler.fit_transform(data.values.reshape(-1,1))
    
    # Train-test split
    train_size = int(len(scaled_data)*0.8)
    train_data = scaled_data[:train_size]
    test_data = scaled_data[train_size:]
    
    # Create sequences
    time_step = 60
    X_train, y_train = create_dataset(train_data, time_step)
    X_test, y_test = create_dataset(test_data, time_step)
    
    # Reshape for LSTM
    X_train = X_train.reshape(X_train.shape[0], X_train.shape[1], 1)
    X_test = X_test.reshape(X_test.shape[0], X_test.shape[1], 1)
    
    # Train model
    model = build_and_train_model(X_train, y_train, X_test, y_test)
    
    # Predict next day
    last_60_days = scaled_data[-60:]
    last_60_days = last_60_days.reshape(1, 60, 1)
    next_day_price = model.predict(last_60_days)
    next_day_price = scaler.inverse_transform(next_day_price)
    
    print(f"Predicted next day closing price for {symbol}: ₹{next_day_price[0][0]:.2f}")
    
    # Plot actual vs predicted
    train_predict = model.predict(X_train)
    test_predict = model.predict(X_test)
    train_predict = scaler.inverse_transform(train_predict)
    test_predict = scaler.inverse_transform(test_predict)
    
    plt.figure(figsize=(14,6))
    plt.plot(data.values, label='Actual Price', color='blue')
    
    # Train plot
    train_plot = np.empty_like(scaled_data)
    train_plot[:, :] = np.nan
    train_plot[time_step:len(train_predict)+time_step, :] = train_predict
    plt.plot(train_plot, label='Train Prediction', color='green')
    
    # Test plot
    test_plot = np.empty_like(scaled_data)
    test_plot[:, :] = np.nan
    test_plot[len(train_predict)+(time_step*2):len(scaled_data), :] = test_predict
    plt.plot(test_plot, label='Test Prediction', color='red')
    
    plt.title(f'{symbol} Stock Price Prediction')
    plt.xlabel('Time')
    plt.ylabel('Price')
    plt.legend()
    plt.show()

if __name__ == "__main__":
    main()
